<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAirDrop</title>
    <style>
        :root {
            --primary-color: #3a8bbb;
            --secondary-color: #f5a623;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --light-bg: #f9f5f0;
            --dark-bg: #2c2c2c;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #777777;
            --border-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --light-bg: #1e1e1e;
            --dark-bg: #121212;
            --card-bg: #2d2d2d;
            --text-color: #f0f0f0;
            --text-light: #aaaaaa;
            --border-color: #444444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .balance {
            font-size: 1rem;
            font-weight: 500;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 0.8rem;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        /* Main Content */
        main {
            padding: 15px;
            padding-bottom: 70px; /* Space for bottom navigation */
            min-height: 100vh;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .card-content {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2a7ba9;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #e69500;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Form Elements */
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Admin Panel Styles */
        #admin-panel {
            display: none;
        }

        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-nav {
            display: flex;
            background-color: var(--card-bg);
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .admin-nav-item {
            padding: 8px 15px;
            margin-right: 10px;
            background-color: var(--light-bg);
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }

        .admin-nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .table th, .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: var(--light-bg);
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-approved {
            background-color: #d1edff;
            color: #004085;
        }

        .badge-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
            
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        @media (min-width: 992px) {
            .container {
                max-width: 970px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1170px;
            }
        }
    </style>
</head>
<body>
    <!-- User Panel (Telegram WebApp) -->
    <div id="user-panel" style="display: none;">
        <header>
            <div class="logo">SuperAirDrop</div>
            <div class="balance" id="user-balance">Balance: 0.00 USDT</div>
            <button class="theme-toggle" id="theme-toggle">üåô</button>
        </header>

        <main>
            <!-- Home Section -->
            <section id="home-section" class="section active">
                <div class="card">
                    <h3 class="card-title">User Info</h3>
                    <div class="card-content">
                        <p id="user-info">Loading user info...</p>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Earning Wallet</h3>
                    <div class="card-content">
                        <p id="earning-wallet">0.00 USDT</p>
                        <p id="min-transfer-info">Minimum 10 USDT to transfer to main balance</p>
                        <button class="btn btn-secondary" id="transfer-btn">Transfer to Main Balance</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Daily Ad Progress</h3>
                    <div class="card-content">
                        <p id="ad-progress">Daily Ad Progress: 0/20</p>
                        <p>Earn 0.15 USDT for every ad.</p>
                        <button class="btn btn-primary" id="watch-ad-btn">Watch Ad</button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h3 class="card-title">Today's Ads</h3>
                        <div class="card-content">
                            <p id="today-ads">0/20</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Referrals</h3>
                        <div class="card-content">
                            <p id="referrals-count">0</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Total Ads</h3>
                        <div class="card-content">
                            <p id="total-ads">0</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Total Income</h3>
                        <div class="card-content">
                            <p id="total-income">0.00 USDT</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Weekly Earnings</h3>
                    <div class="card-content">
                        <canvas id="weekly-chart" height="200"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Invite Friends & Earn</h3>
                    <div class="card-content">
                        <p>Share your referral link and earn 0.5 USDT for each friend who joins!</p>
                        <div id="referral-link-container">
                            <input type="text" id="referral-link" readonly>
                            <button class="btn btn-small" id="copy-link-btn">Copy Link</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Quick Actions</h3>
                    <div class="card-content" id="quick-actions-list">
                        <!-- Quick actions will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section id="tasks-section" class="section">
                <div class="card">
                    <h3 class="card-title">Bonus Tasks</h3>
                    <div class="card-content" id="tasks-list">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Leaderboard Section -->
            <section id="leaderboard-section" class="section">
                <div class="card">
                    <h3 class="card-title">Leaderboard</h3>
                    <div class="card-content">
                        <div class="tabs">
                            <button class="btn btn-small active" data-tab="referrers">Top Referrers</button>
                            <button class="btn btn-small" data-tab="earners">Top Earners</button>
                        </div>
                        <div id="referrers-tab" class="tab-content active">
                            <div id="top-referrers-list">
                                <!-- Top referrers will be loaded here -->
                            </div>
                        </div>
                        <div id="earners-tab" class="tab-content">
                            <div id="top-earners-list">
                                <!-- Top earners will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Profile Section -->
            <section id="profile-section" class="section">
                <div class="card">
                    <h3 class="card-title">Request Withdrawal</h3>
                    <div class="card-content">
                        <p>You need at least 15 referrals to be eligible for withdrawal.</p>
                        <form id="withdrawal-form">
                            <label for="withdrawal-method">Method</label>
                            <select id="withdrawal-method" required>
                                <option value="">Select method</option>
                            </select>
                            
                            <label for="account-id">Account Number/ID</label>
                            <input type="text" id="account-id" placeholder="Enter your wallet address" required>
                            
                            <label for="withdrawal-amount">Amount (USDT)</label>
                            <input type="number" id="withdrawal-amount" min="5" step="0.01" placeholder="Enter amount" required>
                            
                            <button type="submit" class="btn btn-primary">Submit Request</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Withdrawal History</h3>
                    <div class="card-content" id="withdrawal-history">
                        <!-- Withdrawal history will be loaded here -->
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-section="home-section">
                <span class="nav-icon">üè†</span>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-section="tasks-section">
                <span class="nav-icon">‚úÖ</span>
                <span>Tasks</span>
            </a>
            <a href="#" class="nav-item" data-section="leaderboard-section">
                <span class="nav-icon">üèÜ</span>
                <span>Leaderboard</span>
            </a>
            <a href="#" class="nav-item" data-section="profile-section">
                <span class="nav-icon">üë§</span>
                <span>Profile</span>
            </a>
        </nav>
    </div>

    <!-- Admin Panel (Direct Browser Access) -->
    <div id="admin-panel">
        <div id="admin-login" class="admin-login">
            <h2>Admin Login</h2>
            <form id="admin-login-form">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" placeholder="Enter admin password" required>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <p id="admin-login-error" style="color: var(--danger-color); margin-top: 10px; display: none;">Incorrect password</p>
        </div>

        <div id="admin-dashboard" style="display: none;">
            <header>
                <div class="logo">SuperAirDrop Admin</div>
                <button class="btn btn-danger" id="admin-logout">Logout</button>
            </header>

            <main class="container">
                <div class="admin-nav">
                    <div class="admin-nav-item active" data-admin-section="dashboard-section">Dashboard</div>
                    <div class="admin-nav-item" data-admin-section="users-section">User Management</div>
                    <div class="admin-nav-item" data-admin-section="withdrawals-section">Withdrawal Management</div>
                    <div class="admin-nav-item" data-admin-section="tasks-section-admin">Task Management</div>
                    <div class="admin-nav-item" data-admin-section="settings-section">Settings</div>
                </div>

                <!-- Dashboard Section -->
                <section id="dashboard-section" class="admin-section active">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Users</h3>
                            <div class="stat-value" id="total-users">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Withdrawals</h3>
                            <div class="stat-value" id="pending-withdrawals">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total USDT Paid</h3>
                            <div class="stat-value" id="total-usdt-paid">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Ads Watched</h3>
                            <div class="stat-value" id="total-ads-watched">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Recent Activity</h3>
                        <div class="card-content" id="recent-activity">
                            <!-- Recent activity will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- User Management Section -->
                <section id="users-section" class="admin-section">
                    <h2>User Management</h2>
                    <div class="card">
                        <h3 class="card-title">User List</h3>
                        <div class="card-content">
                            <input type="text" id="user-search" placeholder="Search by Telegram ID or Username">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Telegram ID</th>
                                        <th>Username</th>
                                        <th>Main Balance</th>
                                        <th>Earning Wallet</th>
                                        <th>Referrals</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Withdrawal Management Section -->
                <section id="withdrawals-section" class="admin-section">
                    <h2>Withdrawal Management</h2>
                    <div class="card">
                        <h3 class="card-title">Pending Requests</h3>
                        <div class="card-content">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Account ID</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-withdrawals-table">
                                    <!-- Pending withdrawals will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Withdrawal History</h3>
                        <div class="card-content">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawal-history-table">
                                    <!-- Withdrawal history will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Task Management Section -->
                <section id="tasks-section-admin" class="admin-section">
                    <h2>Task Management</h2>
                    <div class="card">
                        <h3 class="card-title">Add New Task</h3>
                        <div class="card-content">
                            <form id="add-task-form">
                                <label for="task-title">Title</label>
                                <input type="text" id="task-title" required>
                                
                                <label for="task-description">Description</label>
                                <input type="text" id="task-description" required>
                                
                                <label for="task-link">Link</label>
                                <input type="url" id="task-link" required>
                                
                                <label for="task-reward">Reward (USDT)</label>
                                <input type="number" id="task-reward" min="0" step="0.01" required>
                                
                                <button type="submit" class="btn btn-primary">Add Task</button>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Existing Tasks</h3>
                        <div class="card-content">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Reward</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body">
                                    <!-- Tasks will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings-section" class="admin-section">
                    <h2>Settings</h2>
                    <div class="card">
                        <h3 class="card-title">App Configuration</h3>
                        <div class="card-content">
                            <form id="settings-form">
                                <label for="referral-bonus">Referral Bonus (USDT)</label>
                                <input type="number" id="referral-bonus" min="0" step="0.01" required>
                                
                                <label for="min-referrals-withdrawal">Minimum Referrals for Withdrawal</label>
                                <input type="number" id="min-referrals-withdrawal" min="0" required>
                                
                                <label for="daily-ad-limit">Daily Ad Limit</label>
                                <input type="number" id="daily-ad-limit" min="0" required>
                                
                                <label for="reward-per-ad">Reward per Ad (USDT)</label>
                                <input type="number" id="reward-per-ad" min="0" step="0.01" required>
                                
                                <label for="min-transfer">Minimum Transfer from Earning to Main Balance (USDT)</label>
                                <input type="number" id="min-transfer" min="0" step="0.01" required>
                                
                                <label for="min-withdrawal">Minimum Withdrawal Amount (USDT)</label>
                                <input type="number" id="min-withdrawal" min="0" step="0.01" required>
                                
                                <button type="submit" class="btn btn-primary">Save Settings</button>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Quick Actions</h3>
                        <div class="card-content">
                            <form id="add-quick-action-form">
                                <label for="quick-action-title">Title</label>
                                <input type="text" id="quick-action-title" required>
                                
                                <label for="quick-action-url">URL</label>
                                <input type="url" id="quick-action-url" required>
                                
                                <button type="submit" class="btn btn-primary">Add Quick Action</button>
                            </form>
                            
                            <div id="quick-actions-admin-list" style="margin-top: 20px;">
                                <!-- Quick actions will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Withdrawal Methods</h3>
                        <div class="card-content">
                            <form id="add-withdrawal-method-form">
                                <label for="withdrawal-method-name">Method Name</label>
                                <input type="text" id="withdrawal-method-name" required>
                                <button type="submit" class="btn btn-primary">Add Method</button>
                            </form>
                            
                            <div id="withdrawal-methods-list" style="margin-top: 20px;">
                                <!-- Withdrawal methods will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- Chart.js for Weekly Earnings -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Firebase Configuration (Replace with your actual config)
        const firebaseConfig = {
  apiKey: "AIzaSyDOMdnCV2hXOveocXtEnnwICzJjp0Bb4Mg",
  authDomain: "superairdrop-90c6d.firebaseapp.com",
  projectId: "superairdrop-90c6d",
  storageBucket: "superairdrop-90c6d.firebasestorage.app",
  messagingSenderId: "623122845001",
  appId: "1:623122845001:web:5b0758778b7424dbf75e98"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let appSettings = {};
        let isTelegramWebApp = false;
        let weeklyChart = null;

        // DOM Elements
        const userPanel = document.getElementById('user-panel');
        const adminPanel = document.getElementById('admin-panel');
        const adminLogin = document.getElementById('admin-login');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLogoutBtn = document.getElementById('admin-logout');
        const themeToggle = document.getElementById('theme-toggle');
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section');
        const adminNavItems = document.querySelectorAll('.admin-nav-item');
        const adminSections = document.querySelectorAll('.admin-section');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                isTelegramWebApp = true;
                userPanel.style.display = 'block';
                adminPanel.style.display = 'none';
                initTelegramWebApp();
            } else {
                // We're in a browser, show admin panel
                userPanel.style.display = 'none';
                adminPanel.style.display = 'block';
                initAdminPanel();
            }

            // Initialize theme
            initTheme();

            // Event listeners
            setupEventListeners();
        });

        // Initialize Telegram WebApp
        function initTelegramWebApp() {
            try {
                // Expand the WebApp to full height
                window.Telegram.WebApp.expand();
                
                // Get user data from Telegram
                const userData = window.Telegram.WebApp.initDataUnsafe.user;
                if (userData) {
                    currentUser = {
                        telegramId: userData.id,
                        username: userData.username || `user_${userData.id}`,
                        firstName: userData.first_name,
                        lastName: userData.last_name || ''
                    };
                    
                    // Initialize user in Firebase
                    initUser();
                } else {
                    showError('Failed to get user data from Telegram');
                }
            } catch (error) {
                console.error('Error initializing Telegram WebApp:', error);
                showError('Failed to initialize Telegram WebApp');
            }
        }

        // Initialize Admin Panel
        function initAdminPanel() {
            // Check if admin is already logged in
            const savedAdminAuth = localStorage.getItem('adminAuth');
            if (savedAdminAuth) {
                try {
                    const authData = JSON.parse(savedAdminAuth);
                    if (authData.isAuthenticated && authData.timestamp > Date.now() - 24 * 60 * 60 * 1000) {
                        // Valid session, show admin dashboard
                        adminLogin.style.display = 'none';
                        adminDashboard.style.display = 'block';
                        loadAdminData();
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing admin auth data:', e);
                }
            }
            
            // Show login form
            adminLogin.style.display = 'block';
            adminDashboard.style.display = 'none';
        }

        // Initialize user in Firebase
        async function initUser() {
            try {
                // Load app settings first
                await loadAppSettings();
                
                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(currentUser.telegramId.toString()).get();
                
                if (userDoc.exists) {
                    // Update user data
                    const userData = userDoc.data();
                    currentUser = { ...currentUser, ...userData };
                    
                    // Update last activity
                    await db.collection('users').doc(currentUser.telegramId.toString()).update({
                        lastActivityDate: new Date()
                    });
                } else {
                    // Create new user
                    const newUserData = {
                        ...currentUser,
                        mainBalance: 0,
                        earningWallet: 0,
                        referralsCount: 0,
                        referredBy: null,
                        adsWatchedToday: 0,
                        lastAdWatchDate: null,
                        totalAdsWatched: 0,
                        totalIncome: 0,
                        completedTasks: [],
                        registrationDate: new Date(),
                        lastActivityDate: new Date()
                    };
                    
                    await db.collection('users').doc(currentUser.telegramId.toString()).set(newUserData);
                    currentUser = { ...currentUser, ...newUserData };
                    
                    // Check if user was referred
                    const urlParams = new URLSearchParams(window.location.search);
                    const startParam = urlParams.get('start');
                    if (startParam && startParam !== currentUser.telegramId.toString()) {
                        // This user was referred by someone
                        await handleReferral(startParam);
                    }
                }
                
                // Update UI with user data
                updateUserUI();
                
            } catch (error) {
                console.error('Error initializing user:', error);
                showError('Failed to load user data');
            }
        }

        // Handle referral
        async function handleReferral(referrerId) {
            try {
                // Update current user
                await db.collection('users').doc(currentUser.telegramId.toString()).update({
                    referredBy: referrerId
                });
                
                // Update referrer's referral count and add bonus
                const referrerDoc = await db.collection('users').doc(referrerId).get();
                if (referrerDoc.exists) {
                    const referrerData = referrerDoc.data();
                    const newReferralsCount = (referrerData.referralsCount || 0) + 1;
                    const newEarningWallet = (referrerData.earningWallet || 0) + (appSettings.referralBonusUsdt || 0.5);
                    
                    await db.collection('users').doc(referrerId).update({
                        referralsCount: newReferralsCount,
                        earningWallet: newEarningWallet
                    });
                }
            } catch (error) {
                console.error('Error handling referral:', error);
            }
        }

        // Load app settings
        async function loadAppSettings() {
            try {
                const settingsDoc = await db.collection('settings').doc('appConfig').get();
                if (settingsDoc.exists) {
                    appSettings = settingsDoc.data();
                } else {
                    // Initialize with default settings
                    appSettings = {
                        referralBonusUsdt: 0.5,
                        minReferralsForWithdrawal: 15,
                        dailyAdLimit: 20,
                        rewardPerAdUsdt: 0.15,
                        minEarningTransferUsdt: 10,
                        minWithdrawalUsdt: 5,
                        quickActions: [
                            { title: "New Update", url: "https://t.me/SuperAirDropBot" },
                            { title: "Subscribe YouTube", url: "https://youtube.com/c/SuperAirDrop" },
                            { title: "AFG COIN Official", url: "https://t.me/AFGCoinOfficial" }
                        ],
                        withdrawalMethods: ["TRC20 USDT Wallet", "BEP20 USDT Wallet"]
                    };
                    
                    await db.collection('settings').doc('appConfig').set(appSettings);
                }
            } catch (error) {
                console.error('Error loading app settings:', error);
            }
        }

        // Update user UI
        function updateUserUI() {
            // Update balance
            document.getElementById('user-balance').textContent = `Balance: ${currentUser.mainBalance || 0} USDT`;
            
            // Update user info
            document.getElementById('user-info').textContent = `Welcome, ${currentUser.firstName}!`;
            
            // Update earning wallet
            document.getElementById('earning-wallet').textContent = `${currentUser.earningWallet || 0} USDT`;
            document.getElementById('min-transfer-info').textContent = `Minimum ${appSettings.minEarningTransferUsdt || 10} USDT to transfer to main balance`;
            
            // Update ad progress
            document.getElementById('ad-progress').textContent = `Daily Ad Progress: ${currentUser.adsWatchedToday || 0}/${appSettings.dailyAdLimit || 20}`;
            
            // Update stats
            document.getElementById('today-ads').textContent = `${currentUser.adsWatchedToday || 0}/${appSettings.dailyAdLimit || 20}`;
            document.getElementById('referrals-count').textContent = currentUser.referralsCount || 0;
            document.getElementById('total-ads').textContent = currentUser.totalAdsWatched || 0;
            document.getElementById('total-income').textContent = `${currentUser.totalIncome || 0} USDT`;
            
            // Update referral link
            document.getElementById('referral-link').value = `https://t.me/SuperAirDropBot/app?start=${currentUser.telegramId}`;
            
            // Load quick actions
            loadQuickActions();
            
            // Load tasks
            loadTasks();
            
            // Load leaderboard
            loadLeaderboard();
            
            // Load withdrawal methods
            loadWithdrawalMethods();
            
            // Load withdrawal history
            loadWithdrawalHistory();
            
            // Initialize weekly chart
            initWeeklyChart();
        }

        // Load quick actions
        function loadQuickActions() {
            const quickActionsList = document.getElementById('quick-actions-list');
            quickActionsList.innerHTML = '';
            
            if (appSettings.quickActions && appSettings.quickActions.length > 0) {
                appSettings.quickActions.forEach(action => {
                    const actionElement = document.createElement('div');
                    actionElement.className = 'quick-action-item';
                    actionElement.style.marginBottom = '10px';
                    actionElement.style.padding = '10px';
                    actionElement.style.backgroundColor = 'var(--light-bg)';
                    actionElement.style.borderRadius = '5px';
                    
                    actionElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${action.title}</strong>
                            </div>
                            <a href="${action.url}" target="_blank" class="btn btn-small">Visit</a>
                        </div>
                    `;
                    
                    quickActionsList.appendChild(actionElement);
                });
            } else {
                quickActionsList.innerHTML = '<p>No quick actions available</p>';
            }
        }

        // Load tasks
        async function loadTasks() {
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '<p>Loading tasks...</p>';
            
            try {
                const tasksSnapshot = await db.collection('tasks').where('isActive', '==', true).get();
                
                if (tasksSnapshot.empty) {
                    tasksList.innerHTML = '<p>No tasks available</p>';
                    return;
                }
                
                tasksList.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    task.id = doc.id;
                    
                    const isCompleted = currentUser.completedTasks && currentUser.completedTasks.includes(task.id);
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task-item';
                    taskElement.style.marginBottom = '15px';
                    taskElement.style.padding = '15px';
                    taskElement.style.backgroundColor = 'var(--light-bg)';
                    taskElement.style.borderRadius = '5px';
                    
                    taskElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${task.title}</strong>
                                <p style="margin: 5px 0; font-size: 0.9rem;">${task.description}</p>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--secondary-color);">Get ${task.rewardUsdt} bonus USDT.</p>
                            </div>
                            <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" 
                                    data-task-id="${task.id}" 
                                    ${isCompleted ? 'disabled' : ''}>
                                ${isCompleted ? 'Claimed' : 'Claim Bonus'}
                            </button>
                        </div>
                    `;
                    
                    tasksList.appendChild(taskElement);
                });
                
                // Add event listeners to claim buttons
                document.querySelectorAll('[data-task-id]').forEach(button => {
                    if (!button.disabled) {
                        button.addEventListener('click', claimTask);
                    }
                });
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasksList.innerHTML = '<p>Failed to load tasks</p>';
            }
        }

        // Claim task
        async function claimTask(event) {
            const taskId = event.target.getAttribute('data-task-id');
            
            try {
                // Get task details
                const taskDoc = await db.collection('tasks').doc(taskId).get();
                if (!taskDoc.exists) {
                    showError('Task not found');
                    return;
                }
                
                const task = taskDoc.data();
                
                // Mark task as completed for user
                await db.collection('users').doc(currentUser.telegramId.toString()).update({
                    completedTasks: firebase.firestore.FieldValue.arrayUnion(taskId),
                    earningWallet: firebase.firestore.FieldValue.increment(task.rewardUsdt)
                });
                
                // Update local state
                if (!currentUser.completedTasks) {
                    currentUser.completedTasks = [];
                }
                currentUser.completedTasks.push(taskId);
                currentUser.earningWallet = (currentUser.earningWallet || 0) + task.rewardUsdt;
                
                // Update UI
                updateUserUI();
                
                // Show success message
                showSuccess(`Task completed! ${task.rewardUsdt} USDT added to your earning wallet.`);
                
            } catch (error) {
                console.error('Error claiming task:', error);
                showError('Failed to claim task');
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                // Load top referrers
                const referrersSnapshot = await db.collection('users')
                    .orderBy('referralsCount', 'desc')
                    .limit(10)
                    .get();
                
                const topReferrersList = document.getElementById('top-referrers-list');
                topReferrersList.innerHTML = '';
                
                if (referrersSnapshot.empty) {
                    topReferrersList.innerHTML = '<p>No data available</p>';
                } else {
                    let rank = 1;
                    referrersSnapshot.forEach(doc => {
                        const user = doc.data();
                        const userElement = document.createElement('div');
                        userElement.className = 'leaderboard-item';
                        userElement.style.display = 'flex';
                        userElement.style.justifyContent = 'space-between';
                        userElement.style.alignItems = 'center';
                        userElement.style.padding = '10px';
                        userElement.style.borderBottom = '1px solid var(--border-color)';
                        
                        userElement.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: bold; margin-right: 10px;">#${rank}</span>
                                <span>${user.username || `User ${user.telegramId}`}</span>
                            </div>
                            <span>${user.referralsCount || 0} referrals</span>
                        `;
                        
                        topReferrersList.appendChild(userElement);
                        rank++;
                    });
                }
                
                // Load top earners
                const earnersSnapshot = await db.collection('users')
                    .orderBy('totalIncome', 'desc')
                    .limit(10)
                    .get();
                
                const topEarnersList = document.getElementById('top-earners-list');
                topEarnersList.innerHTML = '';
                
                if (earnersSnapshot.empty) {
                    topEarnersList.innerHTML = '<p>No data available</p>';
                } else {
                    let rank = 1;
                    earnersSnapshot.forEach(doc => {
                        const user = doc.data();
                        const userElement = document.createElement('div');
                        userElement.className = 'leaderboard-item';
                        userElement.style.display = 'flex';
                        userElement.style.justifyContent = 'space-between';
                        userElement.style.alignItems = 'center';
                        userElement.style.padding = '10px';
                        userElement.style.borderBottom = '1px solid var(--border-color)';
                        
                        userElement.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: bold; margin-right: 10px;">#${rank}</span>
                                <span>${user.username || `User ${user.telegramId}`}</span>
                            </div>
                            <span>${user.totalIncome || 0} USDT</span>
                        `;
                        
                        topEarnersList.appendChild(userElement);
                        rank++;
                    });
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Load withdrawal methods
        function loadWithdrawalMethods() {
            const withdrawalMethodSelect = document.getElementById('withdrawal-method');
            withdrawalMethodSelect.innerHTML = '<option value="">Select method</option>';
            
            if (appSettings.withdrawalMethods && appSettings.withdrawalMethods.length > 0) {
                appSettings.withdrawalMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    withdrawalMethodSelect.appendChild(option);
                });
            }
        }

        // Load withdrawal history
        async function loadWithdrawalHistory() {
            const withdrawalHistory = document.getElementById('withdrawal-history');
            withdrawalHistory.innerHTML = '<p>Loading withdrawal history...</p>';
            
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('userId', '==', currentUser.telegramId.toString())
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (withdrawalsSnapshot.empty) {
                    withdrawalHistory.innerHTML = '<p>No withdrawal history found</p>';
                    return;
                }
                
                withdrawalHistory.innerHTML = '';
                
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const withdrawalElement = document.createElement('div');
                    withdrawalElement.className = 'withdrawal-item';
                    withdrawalElement.style.marginBottom = '10px';
                    withdrawalElement.style.padding = '10px';
                    withdrawalElement.style.backgroundColor = 'var(--light-bg)';
                    withdrawalElement.style.borderRadius = '5px';
                    
                    const statusClass = {
                        'Pending': 'badge-pending',
                        'Approved': 'badge-approved',
                        'Rejected': 'badge-rejected'
                    }[withdrawal.status] || 'badge-pending';
                    
                    withdrawalElement.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${withdrawal.amount} USDT</strong>
                                <p style="margin: 5px 0; font-size: 0.9rem;">${withdrawal.method}</p>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-light);">
                                    ${new Date(withdrawal.timestamp?.toDate()).toLocaleDateString()}
                                </p>
                            </div>
                            <span class="badge ${statusClass}">${withdrawal.status}</span>
                        </div>
                    `;
                    
                    withdrawalHistory.appendChild(withdrawalElement);
                });
                
            } catch (error) {
                console.error('Error loading withdrawal history:', error);
                withdrawalHistory.innerHTML = '<p>Failed to load withdrawal history</p>';
            }
        }

        // Initialize weekly chart
        function initWeeklyChart() {
            const ctx = document.getElementById('weekly-chart').getContext('2d');
            
            // Sample data - in a real app, you would fetch this from Firebase
            const weeklyData = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'USDT Earned',
                    data: [0.45, 0.60, 0.30, 0.75, 0.90, 0.50, 0.65],
                    backgroundColor: 'rgba(58, 139, 187, 0.2)',
                    borderColor: 'rgba(58, 139, 187, 1)',
                    borderWidth: 1,
                    tension: 0.4
                }]
            };
            
            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: weeklyData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' USDT';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav items and sections
                    navItems.forEach(nav => nav.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Add active class to clicked nav item and corresponding section
                    this.classList.add('active');
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Admin navigation
            adminNavItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all admin nav items and sections
                    adminNavItems.forEach(nav => nav.classList.remove('active'));
                    adminSections.forEach(section => section.classList.remove('active'));
                    
                    // Add active class to clicked admin nav item and corresponding section
                    this.classList.add('active');
                    const sectionId = this.getAttribute('data-admin-section');
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);
            
            // Watch ad button
            document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
            
            // Transfer button
            document.getElementById('transfer-btn').addEventListener('click', transferToMainBalance);
            
            // Copy referral link
            document.getElementById('copy-link-btn').addEventListener('click', copyReferralLink);
            
            // Withdrawal form
            document.getElementById('withdrawal-form').addEventListener('submit', submitWithdrawal);
            
            // Admin login
            adminLoginForm.addEventListener('submit', adminLoginSubmit);
            
            // Admin logout
            adminLogoutBtn.addEventListener('click', adminLogout);
            
            // Leaderboard tabs
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('[data-tab]').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
        }

        // Watch ad
        async function watchAd() {
            // Check if user has reached daily limit
            if (currentUser.adsWatchedToday >= appSettings.dailyAdLimit) {
                showError('You have reached your daily ad limit');
                return;
            }
            
            // In a real app, you would integrate with an ad network here
            // For this demo, we'll simulate watching an ad
            
            try {
                // Update user data
                await db.collection('users').doc(currentUser.telegramId.toString()).update({
                    adsWatchedToday: firebase.firestore.FieldValue.increment(1),
                    lastAdWatchDate: new Date(),
                    totalAdsWatched: firebase.firestore.FieldValue.increment(1),
                    earningWallet: firebase.firestore.FieldValue.increment(appSettings.rewardPerAdUsdt),
                    totalIncome: firebase.firestore.FieldValue.increment(appSettings.rewardPerAdUsdt)
                });
                
                // Update local state
                currentUser.adsWatchedToday = (currentUser.adsWatchedToday || 0) + 1;
                currentUser.totalAdsWatched = (currentUser.totalAdsWatched || 0) + 1;
                currentUser.earningWallet = (currentUser.earningWallet || 0) + appSettings.rewardPerAdUsdt;
                currentUser.totalIncome = (currentUser.totalIncome || 0) + appSettings.rewardPerAdUsdt;
                
                // Update UI
                updateUserUI();
                
                // Show success message
                showSuccess(`Ad watched! ${appSettings.rewardPerAdUsdt} USDT added to your earning wallet.`);
                
            } catch (error) {
                console.error('Error watching ad:', error);
                showError('Failed to watch ad');
            }
        }

        // Transfer to main balance
        async function transferToMainBalance() {
            const minTransfer = appSettings.minEarningTransferUsdt || 10;
            
            if (currentUser.earningWallet < minTransfer) {
                showError(`You need at least ${minTransfer} USDT in your earning wallet to transfer`);
                return;
            }
            
            try {
                // Transfer all earning wallet to main balance
                await db.collection('users').doc(currentUser.telegramId.toString()).update({
                    mainBalance: firebase.firestore.FieldValue.increment(currentUser.earningWallet),
                    earningWallet: 0
                });
                
                // Update local state
                currentUser.mainBalance = (currentUser.mainBalance || 0) + currentUser.earningWallet;
                currentUser.earningWallet = 0;
                
                // Update UI
                updateUserUI();
                
                // Show success message
                showSuccess(`Transferred ${currentUser.earningWallet} USDT to your main balance`);
                
            } catch (error) {
                console.error('Error transferring to main balance:', error);
                showError('Failed to transfer funds');
            }
        }

        // Copy referral link
        function copyReferralLink() {
            const referralLink = document.getElementById('referral-link');
            referralLink.select();
            document.execCommand('copy');
            
            // Show success message
            showSuccess('Referral link copied to clipboard!');
        }

        // Submit withdrawal
        async function submitWithdrawal(e) {
            e.preventDefault();
            
            // Check if user meets referral requirement
            const minReferrals = appSettings.minReferralsForWithdrawal || 15;
            if (currentUser.referralsCount < minReferrals) {
                showError(`You need at least ${minReferrals} referrals to be eligible for withdrawal`);
                return;
            }
            
            const method = document.getElementById('withdrawal-method').value;
            const accountId = document.getElementById('account-id').value;
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            
            // Validation
            if (!method) {
                showError('Please select a withdrawal method');
                return;
            }
            
            if (!accountId) {
                showError('Please enter your wallet address');
                return;
            }
            
            const minWithdrawal = appSettings.minWithdrawalUsdt || 5;
            if (amount < minWithdrawal) {
                showError(`Minimum withdrawal amount is ${minWithdrawal} USDT`);
                return;
            }
            
            if (amount > currentUser.mainBalance) {
                showError('Insufficient balance');
                return;
            }
            
            try {
                // Create withdrawal request
                const withdrawalData = {
                    userId: currentUser.telegramId.toString(),
                    username: currentUser.username,
                    amount: amount,
                    method: method,
                    accountID: accountId,
                    status: 'Pending',
                    timestamp: new Date()
                };
                
                await db.collection('withdrawals').add(withdrawalData);
                
                // Deduct amount from user's main balance
                await db.collection('users').doc(currentUser.telegramId.toString()).update({
                    mainBalance: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Update local state
                currentUser.mainBalance -= amount;
                
                // Update UI
                updateUserUI();
                
                // Reset form
                document.getElementById('withdrawal-form').reset();
                
                // Show success message
                showSuccess('Withdrawal request submitted successfully!');
                
            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                showError('Failed to submit withdrawal request');
            }
        }

        // Admin login
        async function adminLoginSubmit(e) {
            e.preventDefault();
            
            const password = adminPasswordInput.value;
            
            try {
                // Check admin password from Firestore
                const settingsDoc = await db.collection('settings').doc('appConfig').get();
                const settings = settingsDoc.data();
                
                if (settings.adminPassword === password) {
                    // Successful login
                    adminLoginError.style.display = 'none';
                    
                    // Save admin auth in localStorage
                    localStorage.setItem('adminAuth', JSON.stringify({
                        isAuthenticated: true,
                        timestamp: Date.now()
                    }));
                    
                    // Show admin dashboard
                    adminLogin.style.display = 'none';
                    adminDashboard.style.display = 'block';
                    
                    // Load admin data
                    loadAdminData();
                    
                } else {
                    // Invalid password
                    adminLoginError.style.display = 'block';
                }
            } catch (error) {
                console.error('Error during admin login:', error);
                adminLoginError.textContent = 'Login error. Please try again.';
                adminLoginError.style.display = 'block';
            }
        }

        // Load admin data
        async function loadAdminData() {
            // Load summary statistics
            await loadAdminStats();
            
            // Load user management
            await loadUsers();
            
            // Load withdrawal management
            await loadWithdrawals();
            
            // Load task management
            await loadAdminTasks();
            
            // Load settings
            await loadAdminSettings();
        }

        // Load admin stats
        async function loadAdminStats() {
            try {
                // Total users
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('total-users').textContent = usersSnapshot.size;
                
                // Pending withdrawals
                const pendingWithdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'Pending')
                    .get();
                document.getElementById('pending-withdrawals').textContent = pendingWithdrawalsSnapshot.size;
                
                // Total USDT paid (from approved withdrawals)
                const approvedWithdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'Approved')
                    .get();
                
                let totalPaid = 0;
                approvedWithdrawalsSnapshot.forEach(doc => {
                    totalPaid += doc.data().amount;
                });
                document.getElementById('total-usdt-paid').textContent = totalPaid.toFixed(2);
                
                // Total ads watched
                const users = await db.collection('users').get();
                let totalAds = 0;
                users.forEach(doc => {
                    totalAds += doc.data().totalAdsWatched || 0;
                });
                document.getElementById('total-ads-watched').textContent = totalAds;
                
                // Recent activity
                await loadRecentActivity();
                
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            const recentActivity = document.getElementById('recent-activity');
            recentActivity.innerHTML = '<p>Loading recent activity...</p>';
            
            try {
                // Get recent users (last 5)
                const recentUsersSnapshot = await db.collection('users')
                    .orderBy('registrationDate', 'desc')
                    .limit(5)
                    .get();
                
                // Get recent withdrawals (last 5)
                const recentWithdrawalsSnapshot = await db.collection('withdrawals')
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                recentActivity.innerHTML = '';
                
                // Add recent users
                if (!recentUsersSnapshot.empty) {
                    const usersSection = document.createElement('div');
                    usersSection.innerHTML = '<h4>Recent Users</h4>';
                    
                    recentUsersSnapshot.forEach(doc => {
                        const user = doc.data();
                        const userElement = document.createElement('div');
                        userElement.style.padding = '5px 0';
                        userElement.style.borderBottom = '1px solid var(--border-color)';
                        userElement.innerHTML = `${user.username} joined on ${new Date(user.registrationDate?.toDate()).toLocaleDateString()}`;
                        usersSection.appendChild(userElement);
                    });
                    
                    recentActivity.appendChild(usersSection);
                }
                
                // Add recent withdrawals
                if (!recentWithdrawalsSnapshot.empty) {
                    const withdrawalsSection = document.createElement('div');
                    withdrawalsSection.innerHTML = '<h4 style="margin-top: 15px;">Recent Withdrawals</h4>';
                    
                    recentWithdrawalsSnapshot.forEach(doc => {
                        const withdrawal = doc.data();
                        const withdrawalElement = document.createElement('div');
                        withdrawalElement.style.padding = '5px 0';
                        withdrawalElement.style.borderBottom = '1px solid var(--border-color)';
                        
                        const statusClass = {
                            'Pending': 'badge-pending',
                            'Approved': 'badge-approved',
                            'Rejected': 'badge-rejected'
                        }[withdrawal.status] || 'badge-pending';
                        
                        withdrawalElement.innerHTML = `
                            ${withdrawal.username} - ${withdrawal.amount} USDT - 
                            <span class="badge ${statusClass}">${withdrawal.status}</span>
                        `;
                        withdrawalsSection.appendChild(withdrawalElement);
                    });
                    
                    recentActivity.appendChild(withdrawalsSection);
                }
                
                if (recentUsersSnapshot.empty && recentWithdrawalsSnapshot.empty) {
                    recentActivity.innerHTML = '<p>No recent activity</p>';
                }
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                recentActivity.innerHTML = '<p>Failed to load recent activity</p>';
            }
        }

        // Load users for admin
        async function loadUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '<tr><td colspan="6">Loading users...</td></tr>';
            
            try {
                const usersSnapshot = await db.collection('users').get();
                
                if (usersSnapshot.empty) {
                    usersTableBody.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
                    return;
                }
                
                usersTableBody.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const userElement = document.createElement('tr');
                    
                    userElement.innerHTML = `
                        <td>${user.telegramId}</td>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.mainBalance || 0} USDT</td>
                        <td>${user.earningWallet || 0} USDT</td>
                        <td>${user.referralsCount || 0}</td>
                        <td>
                            <button class="btn btn-small" data-user-id="${user.telegramId}" onclick="editUser('${user.telegramId}')">Edit</button>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(userElement);
                });
                
                // Add event listener for user search
                document.getElementById('user-search').addEventListener('input', searchUsers);
                
            } catch (error) {
                console.error('Error loading users:', error);
                usersTableBody.innerHTML = '<tr><td colspan="6">Failed to load users</td></tr>';
            }
        }

        // Search users
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const usersTableBody = document.getElementById('users-table-body');
            
            try {
                const usersSnapshot = await db.collection('users').get();
                
                if (usersSnapshot.empty) {
                    usersTableBody.innerHTML = '<tr><td colspan="6">No users found</td></tr>';
                    return;
                }
                
                usersTableBody.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    
                    // Filter by search term
                    if (searchTerm && 
                        !user.telegramId.toString().includes(searchTerm) && 
                        !(user.username && user.username.toLowerCase().includes(searchTerm))) {
                        return;
                    }
                    
                    const userElement = document.createElement('tr');
                    
                    userElement.innerHTML = `
                        <td>${user.telegramId}</td>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.mainBalance || 0} USDT</td>
                        <td>${user.earningWallet || 0} USDT</td>
                        <td>${user.referralsCount || 0}</td>
                        <td>
                            <button class="btn btn-small" data-user-id="${user.telegramId}" onclick="editUser('${user.telegramId}')">Edit</button>
                        </td>
                    `;
                    
                    usersTableBody.appendChild(userElement);
                });
                
                if (usersTableBody.children.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="6">No users match your search</td></tr>';
                }
                
            } catch (error) {
                console.error('Error searching users:', error);
            }
        }

        // Edit user (placeholder function)
        function editUser(userId) {
            alert(`Edit user functionality would open a modal to edit user ${userId}`);
            // In a real implementation, you would open a modal with user details and edit form
        }

        // Load withdrawals for admin
        async function loadWithdrawals() {
            await loadPendingWithdrawals();
            await loadWithdrawalHistoryAdmin();
        }

        // Load pending withdrawals for admin
        async function loadPendingWithdrawals() {
            const pendingWithdrawalsTable = document.getElementById('pending-withdrawals-table');
            pendingWithdrawalsTable.innerHTML = '<tr><td colspan="6">Loading pending withdrawals...</td></tr>';
            
            try {
                const pendingWithdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'Pending')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (pendingWithdrawalsSnapshot.empty) {
                    pendingWithdrawalsTable.innerHTML = '<tr><td colspan="6">No pending withdrawals</td></tr>';
                    return;
                }
                
                pendingWithdrawalsTable.innerHTML = '';
                
                pendingWithdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const withdrawalElement = document.createElement('tr');
                    
                    withdrawalElement.innerHTML = `
                        <td>${withdrawal.username}</td>
                        <td>${withdrawal.amount} USDT</td>
                        <td>${withdrawal.method}</td>
                        <td>${withdrawal.accountID}</td>
                        <td>${new Date(withdrawal.timestamp?.toDate()).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-success btn-small" onclick="approveWithdrawal('${doc.id}')">Approve</button>
                            <button class="btn btn-danger btn-small" onclick="rejectWithdrawal('${doc.id}')">Reject</button>
                        </td>
                    `;
                    
                    pendingWithdrawalsTable.appendChild(withdrawalElement);
                });
                
            } catch (error) {
                console.error('Error loading pending withdrawals:', error);
                pendingWithdrawalsTable.innerHTML = '<tr><td colspan="6">Failed to load pending withdrawals</td></tr>';
            }
        }

        // Load withdrawal history for admin
        async function loadWithdrawalHistoryAdmin() {
            const withdrawalHistoryTable = document.getElementById('withdrawal-history-table');
            withdrawalHistoryTable.innerHTML = '<tr><td colspan="5">Loading withdrawal history...</td></tr>';
            
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                if (withdrawalsSnapshot.empty) {
                    withdrawalHistoryTable.innerHTML = '<tr><td colspan="5">No withdrawal history</td></tr>';
                    return;
                }
                
                withdrawalHistoryTable.innerHTML = '';
                
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const statusClass = {
                        'Pending': 'badge-pending',
                        'Approved': 'badge-approved',
                        'Rejected': 'badge-rejected'
                    }[withdrawal.status] || 'badge-pending';
                    
                    const withdrawalElement = document.createElement('tr');
                    
                    withdrawalElement.innerHTML = `
                        <td>${withdrawal.username}</td>
                        <td>${withdrawal.amount} USDT</td>
                        <td>${withdrawal.method}</td>
                        <td><span class="badge ${statusClass}">${withdrawal.status}</span></td>
                        <td>${new Date(withdrawal.timestamp?.toDate()).toLocaleDateString()}</td>
                    `;
                    
                    withdrawalHistoryTable.appendChild(withdrawalElement);
                });
                
            } catch (error) {
                console.error('Error loading withdrawal history:', error);
                withdrawalHistoryTable.innerHTML = '<tr><td colspan="5">Failed to load withdrawal history</td></tr>';
            }
        }

        // Approve withdrawal
        async function approveWithdrawal(withdrawalId) {
            try {
                // Update withdrawal status
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'Approved'
                });
                
                // Reload withdrawals
                await loadWithdrawals();
                
                // Show success message
                showSuccess('Withdrawal approved successfully');
                
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showError('Failed to approve withdrawal');
            }
        }

        // Reject withdrawal
        async function rejectWithdrawal(withdrawalId) {
            try {
                // Get withdrawal details
                const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                const withdrawal = withdrawalDoc.data();
                
                // Return funds to user
                await db.collection('users').doc(withdrawal.userId).update({
                    mainBalance: firebase.firestore.FieldValue.increment(withdrawal.amount)
                });
                
                // Update withdrawal status
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'Rejected'
                });
                
                // Reload withdrawals
                await loadWithdrawals();
                
                // Show success message
                showSuccess('Withdrawal rejected and funds returned to user');
                
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showError('Failed to reject withdrawal');
            }
        }

        // Load tasks for admin
        async function loadAdminTasks() {
            const tasksTableBody = document.getElementById('tasks-table-body');
            tasksTableBody.innerHTML = '<tr><td colspan="5">Loading tasks...</td></tr>';
            
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                
                if (tasksSnapshot.empty) {
                    tasksTableBody.innerHTML = '<tr><td colspan="5">No tasks found</td></tr>';
                    return;
                }
                
                tasksTableBody.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    const taskElement = document.createElement('tr');
                    
                    taskElement.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.description}</td>
                        <td>${task.rewardUsdt} USDT</td>
                        <td>${task.isActive ? 'Active' : 'Inactive'}</td>
                        <td>
                            <button class="btn btn-small" onclick="editTask('${doc.id}')">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteTask('${doc.id}')">Delete</button>
                        </td>
                    `;
                    
                    tasksTableBody.appendChild(taskElement);
                });
                
                // Add event listener for add task form
                document.getElementById('add-task-form').addEventListener('submit', addTask);
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasksTableBody.innerHTML = '<tr><td colspan="5">Failed to load tasks</td></tr>';
            }
        }

        // Add task
        async function addTask(e) {
            e.preventDefault();
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const link = document.getElementById('task-link').value;
            const reward = parseFloat(document.getElementById('task-reward').value);
            
            try {
                await db.collection('tasks').add({
                    title: title,
                    description: description,
                    link: link,
                    rewardUsdt: reward,
                    isActive: true
                });
                
                // Reset form
                document.getElementById('add-task-form').reset();
                
                // Reload tasks
                await loadAdminTasks();
                
                // Show success message
                showSuccess('Task added successfully');
                
            } catch (error) {
                console.error('Error adding task:', error);
                showError('Failed to add task');
            }
        }

        // Edit task (placeholder function)
        function editTask(taskId) {
            alert(`Edit task functionality would open a modal to edit task ${taskId}`);
            // In a real implementation, you would open a modal with task details and edit form
        }

        // Delete task
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    await db.collection('tasks').doc(taskId).delete();
                    
                    // Reload tasks
                    await loadAdminTasks();
                    
                    // Show success message
                    showSuccess('Task deleted successfully');
                    
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showError('Failed to delete task');
                }
            }
        }

        // Load admin settings
        async function loadAdminSettings() {
            try {
                // Load app settings
                const settingsDoc = await db.collection('settings').doc('appConfig').get();
                const settings = settingsDoc.data();
                
                // Populate form
                document.getElementById('referral-bonus').value = settings.referralBonusUsdt || 0.5;
                document.getElementById('min-referrals-withdrawal').value = settings.minReferralsForWithdrawal || 15;
                document.getElementById('daily-ad-limit').value = settings.dailyAdLimit || 20;
                document.getElementById('reward-per-ad').value = settings.rewardPerAdUsdt || 0.15;
                document.getElementById('min-transfer').value = settings.minEarningTransferUsdt || 10;
                document.getElementById('min-withdrawal').value = settings.minWithdrawalUsdt || 5;
                
                // Load quick actions
                loadQuickActionsAdmin();
                
                // Load withdrawal methods
                loadWithdrawalMethodsAdmin();
                
                // Add event listeners
                document.getElementById('settings-form').addEventListener('submit', saveSettings);
                document.getElementById('add-quick-action-form').addEventListener('submit', addQuickAction);
                document.getElementById('add-withdrawal-method-form').addEventListener('submit', addWithdrawalMethod);
                
            } catch (error) {
                console.error('Error loading admin settings:', error);
            }
        }

        // Save settings
        async function saveSettings(e) {
            e.preventDefault();
            
            const updatedSettings = {
                referralBonusUsdt: parseFloat(document.getElementById('referral-bonus').value),
                minReferralsForWithdrawal: parseInt(document.getElementById('min-referrals-withdrawal').value),
                dailyAdLimit: parseInt(document.getElementById('daily-ad-limit').value),
                rewardPerAdUsdt: parseFloat(document.getElementById('reward-per-ad').value),
                minEarningTransferUsdt: parseFloat(document.getElementById('min-transfer').value),
                minWithdrawalUsdt: parseFloat(document.getElementById('min-withdrawal').value)
            };
            
            try {
                await db.collection('settings').doc('appConfig').update(updatedSettings);
                
                // Update local appSettings
                appSettings = { ...appSettings, ...updatedSettings };
                
                // Show success message
                showSuccess('Settings saved successfully');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showError('Failed to save settings');
            }
        }

        // Load quick actions for admin
        function loadQuickActionsAdmin() {
            const quickActionsList = document.getElementById('quick-actions-admin-list');
            quickActionsList.innerHTML = '';
            
            if (appSettings.quickActions && appSettings.quickActions.length > 0) {
                appSettings.quickActions.forEach((action, index) => {
                    const actionElement = document.createElement('div');
                    actionElement.className = 'quick-action-item';
                    actionElement.style.display = 'flex';
                    actionElement.style.justifyContent = 'space-between';
                    actionElement.style.alignItems = 'center';
                    actionElement.style.padding = '10px';
                    actionElement.style.marginBottom = '10px';
                    actionElement.style.backgroundColor = 'var(--light-bg)';
                    actionElement.style.borderRadius = '5px';
                    
                    actionElement.innerHTML = `
                        <div>
                            <strong>${action.title}</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: var(--text-light);">${action.url}</p>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteQuickAction(${index})">Delete</button>
                    `;
                    
                    quickActionsList.appendChild(actionElement);
                });
            } else {
                quickActionsList.innerHTML = '<p>No quick actions configured</p>';
            }
        }

        // Add quick action
        async function addQuickAction(e) {
            e.preventDefault();
            
            const title = document.getElementById('quick-action-title').value;
            const url = document.getElementById('quick-action-url').value;
            
            try {
                // Update quick actions in Firestore
                const updatedQuickActions = [...(appSettings.quickActions || []), { title, url }];
                await db.collection('settings').doc('appConfig').update({
                    quickActions: updatedQuickActions
                });
                
                // Update local appSettings
                appSettings.quickActions = updatedQuickActions;
                
                // Reset form
                document.getElementById('add-quick-action-form').reset();
                
                // Reload quick actions
                loadQuickActionsAdmin();
                
                // Show success message
                showSuccess('Quick action added successfully');
                
            } catch (error) {
                console.error('Error adding quick action:', error);
                showError('Failed to add quick action');
            }
        }

        // Delete quick action
        async function deleteQuickAction(index) {
            if (confirm('Are you sure you want to delete this quick action?')) {
                try {
                    const updatedQuickActions = [...appSettings.quickActions];
                    updatedQuickActions.splice(index, 1);
                    
                    // Update quick actions in Firestore
                    await db.collection('settings').doc('appConfig').update({
                        quickActions: updatedQuickActions
                    });
                    
                    // Update local appSettings
                    appSettings.quickActions = updatedQuickActions;
                    
                    // Reload quick actions
                    loadQuickActionsAdmin();
                    
                    // Show success message
                    showSuccess('Quick action deleted successfully');
                    
                } catch (error) {
                    console.error('Error deleting quick action:', error);
                    showError('Failed to delete quick action');
                }
            }
        }

        // Load withdrawal methods for admin
        function loadWithdrawalMethodsAdmin() {
            const withdrawalMethodsList = document.getElementById('withdrawal-methods-list');
            withdrawalMethodsList.innerHTML = '';
            
            if (appSettings.withdrawalMethods && appSettings.withdrawalMethods.length > 0) {
                appSettings.withdrawalMethods.forEach((method, index) => {
                    const methodElement = document.createElement('div');
                    methodElement.className = 'withdrawal-method-item';
                    methodElement.style.display = 'flex';
                    methodElement.style.justifyContent = 'space-between';
                    methodElement.style.alignItems = 'center';
                    methodElement.style.padding = '10px';
                    methodElement.style.marginBottom = '10px';
                    methodElement.style.backgroundColor = 'var(--light-bg)';
                    methodElement.style.borderRadius = '5px';
                    
                    methodElement.innerHTML = `
                        <div>${method}</div>
                        <button class="btn btn-danger btn-small" onclick="deleteWithdrawalMethod(${index})">Delete</button>
                    `;
                    
                    withdrawalMethodsList.appendChild(methodElement);
                });
            } else {
                withdrawalMethodsList.innerHTML = '<p>No withdrawal methods configured</p>';
            }
        }

        // Add withdrawal method
        async function addWithdrawalMethod(e) {
            e.preventDefault();
            
            const methodName = document.getElementById('withdrawal-method-name').value;
            
            try {
                // Update withdrawal methods in Firestore
                const updatedMethods = [...(appSettings.withdrawalMethods || []), methodName];
                await db.collection('settings').doc('appConfig').update({
                    withdrawalMethods: updatedMethods
                });
                
                // Update local appSettings
                appSettings.withdrawalMethods = updatedMethods;
                
                // Reset form
                document.getElementById('add-withdrawal-method-form').reset();
                
                // Reload withdrawal methods
                loadWithdrawalMethodsAdmin();
                
                // Show success message
                showSuccess('Withdrawal method added successfully');
                
            } catch (error) {
                console.error('Error adding withdrawal method:', error);
                showError('Failed to add withdrawal method');
            }
        }

        // Delete withdrawal method
        async function deleteWithdrawalMethod(index) {
            if (confirm('Are you sure you want to delete this withdrawal method?')) {
                try {
                    const updatedMethods = [...appSettings.withdrawalMethods];
                    updatedMethods.splice(index, 1);
                    
                    // Update withdrawal methods in Firestore
                    await db.collection('settings').doc('appConfig').update({
                        withdrawalMethods: updatedMethods
                    });
                    
                    // Update local appSettings
                    appSettings.withdrawalMethods = updatedMethods;
                    
                    // Reload withdrawal methods
                    loadWithdrawalMethodsAdmin();
                    
                    // Show success message
                    showSuccess('Withdrawal method deleted successfully');
                    
                } catch (error) {
                    console.error('Error deleting withdrawal method:', error);
                    showError('Failed to delete withdrawal method');
                }
            }
        }

        // Admin logout
        function adminLogout() {
            // Clear admin auth from localStorage
            localStorage.removeItem('adminAuth');
            
            // Show login form
            adminDashboard.style.display = 'none';
            adminLogin.style.display = 'block';
            
            // Clear password field
            adminPasswordInput.value = '';
        }

        // Initialize theme
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }

        // Update theme toggle button
        function updateThemeToggle(theme) {
            themeToggle.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Show success message
        function showSuccess(message) {
            // In a real implementation, you would use a toast notification library
            alert(`Success: ${message}`);
        }

        // Show error message
        function showError(message) {
            // In a real implementation, you would use a toast notification library
            alert(`Error: ${message}`);
        }

        // Make functions available globally for onclick handlers
        window.editUser = editUser;
        window.approveWithdrawal = approveWithdrawal;
        window.rejectWithdrawal = rejectWithdrawal;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.deleteQuickAction = deleteQuickAction;
        window.deleteWithdrawalMethod = deleteWithdrawalMethod;
    </script>
</body>
</html>
